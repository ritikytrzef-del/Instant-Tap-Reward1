<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Instant Tap Reward</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- TELEGA.IO SDK -->
<script src="https://inapp.telega.io/sdk/v1/sdk.js"></script>

<style>
  /* Purana CSS same + extra for debugging */
  #debugLog { position:fixed; bottom:10px; left:10px; background:#111; color:#0ff; padding:10px; font-size:12px; max-width:300px; z-index:10000; display:none; }
  #adBtn.loading::after { content:''; position:absolute; top:50%; left:50%; width:20px; height:20px; margin:-10px 0 0 -10px; border:2px solid #fff; border-top:2px solid transparent; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
</style>
</head>
<body>

<!-- HTML same as before (top, startScreen, gameArea, etc.) -->
<div id="top">
  <div id="name">Guest</div>
  <div id="pointBox">Points: <span id="point">0</span></div>
  <button id="walletBtn" onclick="openWallet()">Wallet</button>
</div>

<div id="startScreen">
  <h1>Instant Tap Reward</h1>
  <p>Tap & Earn Real Rewards!</p>
  <button id="startBtn" onclick="startGame()">START TAPPING</button>
</div>

<div id="gameArea" style="display:none">
  <div id="tapArea" onclick="tap(event)">
    <div class="tap-main-text">TAP AND</div>
    <div class="tap-sub-text">EARN</div>
    <div id="tapCount">0</div>
  </div>
  <div id="float"></div>
  <div id="energyBar"><div id="energyFill"></div></div>
  <div id="energyText">Energy: <span id="energyNow">10</span>/10<br>
    <small style="color:#888">Daily: <span id="dailyCount">0</span>/3200</small>
  </div>
  <button id="adBtn" onclick="watchAd()">Watch Ad & Recharge</button>
  <div id="adStatus"></div>
</div>

<!-- Wallet screens same... (googleTab, ltcTab, historyTab, redeemModal) -->
<div id="walletScreen" class="screen">
  <!-- Same as before -->
  <button class="close" onclick="closeScreen()">X</button>
  <h2 style="text-align:center;color:#00ffff;margin:20px 0">Points: <span id="wPoint">0</span></h2>
  <div class="tab-container">
    <button class="tab-btn active" onclick="showTab('google')">Google Play</button>
    <button class="tab-btn" onclick="showTab('ltc')">Litecoin</button>
    <button class="tab-btn" onclick="showTab('history')">History</button>
  </div>
  <div id="googleTab"><div class="voucher-grid" id="vouchers"></div></div>
  <div id="ltcTab" style="display:none">
    <div style="background:#111;padding:35px;border-radius:24px;text-align:center;border:2px solid #333;margin-top:20px">
      <h3 style="color:#00ffff;margin-bottom:15px">Litecoin Withdrawal</h3>
      <p style="color:#888;margin:15px 0">3200 Points = $0.1 LTC</p>
      <input type="text" id="ltcAddr" placeholder="Enter Your LTC Address" style="width:100%;padding:16px;background:#000;border:2px solid #00ffff;border-radius:12px;color:#fff;margin:10px 0;font-size:16px">
      <button onclick="withdrawLTC()" style="background:linear-gradient(135deg,#00ffff,#8a2be2);color:#000;padding:16px;border-radius:16px;width:100%;font-weight:bold;font-size:18px">Withdraw $0.1 LTC</button>
    </div>
  </div>
  <div id="historyTab" style="display:none">
    <h3 style="text-align:center;color:#00ffff;margin:25px 0">Withdrawal History</h3>
    <div id="historyList"><p style="text-align:center;color:#666">No history yet</p></div>
  </div>
</div>

<div class="modal" id="redeemModal" style="display:none">
  <div style="padding:20px;text-align:center">
    <h2 style="color:#00ffff">Redeem Google Play Code</h2>
    <input type="text" id="redeemName" placeholder="Your Full Name" style="width:100%;padding:10px;margin:10px 0;background:#111;border:1px solid #333;color:#fff;border-radius:5px">
    <input type="email" id="redeemEmail" placeholder="Your Gmail Address" style="width:100%;padding:10px;margin:10px 0;background:#111;border:1px solid #333;color:#fff;border-radius:5px">
    <button onclick="submitRedeem()" style="background:linear-gradient(135deg,#00ffff,#8a2be2);color:#000;padding:12px;border-radius:20px;width:100%;font-weight:bold">Submit Request</button>
    <button onclick="closeModal()" style="background:#333;color:#fff;padding:12px;border-radius:20px;width:100%;margin-top:10px">Cancel</button>
  </div>
</div>

<!-- Debug log div -->
<div id="debugLog"></div>

<script>
// Purana script same + fixed ads
Telegram.WebApp.ready(); 
Telegram.WebApp.expand();

let telegaAds;
const TOKEN = 'e8f424c5-34c4-4312-b839-6b6889d12180'; // Dashboard se verify karo
const AD_BLOCK_UUID = "65a61c99-4654-42be-a794-dcbe752247f2"; // Naya generate karo if needed
let adCooldown = false;
const AD_COOLDOWN_SECONDS = 15;

let debugLog = document.getElementById('debugLog');
function logDebug(msg) {
  console.log('[Telega Debug]', msg);
  debugLog.innerHTML += msg + '<br>';
  debugLog.style.display = 'block';
}

// SDK Init with better check
if (window.addEventListener) {
  window.addEventListener('load', () => {
    setTimeout(() => { // Delay for full load
      if (window.TelegaIn && window.TelegaIn.AdsController) {
        telegaAds = window.TelegaIn.AdsController.create_miniapp({ token: TOKEN });
        logDebug('SDK Loaded & Init Success');
        console.log('Telega Ready:', telegaAds);
      } else {
        logDebug('ERROR: TelegaIn SDK Not Found! Check script src or network.');
        Telegram.WebApp.showAlert('Ad SDK load nahi hua. Refresh try karo.');
      }
    }, 1000);
  });
} else {
  logDebug('Window load event not supported');
}

// Fixed watchAd with timeout & rewarded type
async function watchAd() {
  if (adCooldown) {
    Telegram.WebApp.showAlert(`Wait ${AD_COOLDOWN_SECONDS}s ðŸ˜…`);
    return;
  }

  const btn = document.getElementById('adBtn');
  const status = document.getElementById('adStatus');

  btn.disabled = true;
  btn.classList.add('loading');
  btn.innerText = 'Loading Rewarded Ad...';
  status.style.display = 'block';
  status.innerText = 'Connecting to ad server...';
  status.style.color = '#0ff';

  if (!telegaAds) {
    logDebug('ERROR: Ads Controller Not Init');
    status.innerText = 'SDK Error - Refresh App';
    status.style.color = '#ff4444';
    setTimeout(resetAdUI, 2000);
    return;
  }

  // Timeout for stuck loading
  const adTimeout = setTimeout(() => {
    logDebug('TIMEOUT: Ad load stuck after 5s');
    status.innerText = 'Ad timeout - No ads available';
    status.style.color = '#ff4444';
    Telegram.WebApp.showAlert('Ads temporarily unavailable. Dashboard check karo.');
    resetAdUI();
  }, 5000);

  try {
    logDebug('Calling ad_show with rewarded params');
    const adResult = await telegaAds.ad_show({
      adBlockUuid: AD_BLOCK_UUID,
      type: 'rewarded'  // Explicit rewarded format (video/post)
      // onClose: () => logDebug('Ad closed by user')  // If supported
    });

    clearTimeout(adTimeout);

    logDebug(`Ad Result: ${JSON.stringify(adResult)}`);

    // Check completion (Telega returns true on full view)
    if (adResult === true || (adResult && adResult.completed)) {
      energy = 10;
      startAdCooldown();
      update();
      Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
      status.innerText = 'Ad Watched! Energy Full âš¡';
      status.style.color = '#00ff88';
      Telegram.WebApp.showAlert('Success! Energy recharged. Keep tapping!');
      logDebug('REWARD GRANTED: Energy +10');
    } else {
      throw new Error('Ad not completed (skipped)');
    }
  } catch (error) {
    clearTimeout(adTimeout);
    logDebug(`Ad Error: ${error.message}`);
    status.innerText = 'Ad failed (skipped/error)';
    status.style.color = '#ff4444';
    Telegram.WebApp.showAlert(`Ad issue: ${error.message}. Try again or check dashboard.`);
  } finally {
    setTimeout(resetAdUI, 2500);
  }
}

function resetAdUI() {
  const btn = document.getElementById('adBtn');
  const status = document.getElementById('adStatus');
  btn.classList.remove('loading');
  btn.disabled = false;
  btn.innerText = adCooldown ? `Cooldown: ${AD_COOLDOWN_SECONDS}s` : 'Watch Ad & Recharge';
  status.style.display = 'none';
}

function startAdCooldown() {
  adCooldown = true;
  let timer = AD_COOLDOWN_SECONDS;
  const interval = setInterval(() => {
    timer--;
    document.getElementById('adBtn').innerText = `Cooldown: ${timer}s`;
    if (timer <= 0) {
      clearInterval(interval);
      adCooldown = false;
      resetAdUI();
    }
  }, 1000);
}

// Baaki code same (user init, tap, update, vouchers, history, redeem, etc.)
const GOOGLE_PLAY_LOGO = "https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Google_Play_Store_badge_EN.svg/1024px-Google_Play_Store_badge_EN.svg.png";
const BOT_TOKEN = "8510745729:AAHIr4lQiAeWoxBLq7QA7PyHcG3jaBZDcZQ";
const CHANNEL_ID = "@Instanttapreward";

const user = Telegram.WebApp.initDataUnsafe.user || {};
const userId = user.id ? user.id.toString() : "guest"+Date.now();
const userName = user.first_name || user.username || "Guest";
document.getElementById("name").textContent = userName;

const POINT_KEY = "point_"+userId;
const DAILY_KEY = "daily_tap_"+userId;
const DATE_KEY = "daily_date_"+userId;
const HISTORY_KEY = "history_"+userId;

let points = parseInt(localStorage.getItem(POINT_KEY)) || 0;
let energy = 10;
let todayTaps = 0;
let selectedINR = 0;
const DAILY_LIMIT = 3200;

const today = new Date().toISOString().split('T')[0];
if (localStorage.getItem(DATE_KEY) !== today) {
  todayTaps = 0;
  localStorage.setItem(DAILY_KEY, "0");
  localStorage.setItem(DATE_KEY, today);
} else {
  todayTaps = parseInt(localStorage.getItem(DAILY_KEY)) || 0;
}

const vouchers = [
  {inr:10, points:3200},
  {inr:20, points:6400},
  {inr:50, points:16000},
  {inr:100, points:32000}
];

function tap(e) {
  if (energy <= 0 || todayTaps >= DAILY_LIMIT) {
    if (todayTaps >= DAILY_LIMIT) Telegram.WebApp.showAlert("Daily limit 3200 ho gaya! Kal aana");
    return;
  }
  energy--; points++; todayTaps++;
  localStorage.setItem(POINT_KEY, points);
  localStorage.setItem(DAILY_KEY, todayTaps);

  const p = document.createElement("div"); 
  p.className="plus"; p.innerText="+1";
  p.style.left = (e.touches?.[0]?.clientX || e.clientX - 20) + "px";
  p.style.top = (e.touches?.[0]?.clientY || e.clientY - 20) + "px";
  document.getElementById("float").appendChild(p);
  setTimeout(() => p.remove(), 1000);

  Telegram.WebApp.HapticFeedback.impactOccurred("medium");
  update();
}

function update() {
  document.getElementById("point").innerText = points.toLocaleString();
  document.getElementById("tapCount").innerText = points.toLocaleString();
  if(document.getElementById("wPoint")) document.getElementById("wPoint").innerText = points.toLocaleString();
  document.getElementById("energyFill").style.width = (energy/10)*100 + "%";
  document.getElementById("energyNow").innerText = energy;
  document.getElementById("dailyCount").innerText = todayTaps;
  loadVouchers();
  updateHistory();
}

function loadVouchers() {
  let html = "";
  vouchers.forEach(v => {
    const progress = Math.min((points / v.points)*100, 100);
    const unlocked = points >= v.points;
    html += `<div class="voucher">
      <div class="v-header">
        <img src="${GOOGLE_PLAY_LOGO}" alt="Google Play">
        <span>â‚¹${v.inr} Gift Card</span>
      </div>
      <div class="v-amount">â‚¹${v.inr}</div>
      <div class="progress"><div class="progress-fill" style="width:${progress}%"></div></div>
      <div class="progress-text">${points.toLocaleString()}/${v.points.toLocaleString()} pts</div>
      <button class="redeem-btn ${unlocked?'active':''}" ${unlocked?`onclick="openRedeem(${v.inr})"`:''}>
        ${unlocked?'Redeem Now':'Locked'}
      </button>
    </div>`;
  });
  document.getElementById("vouchers").innerHTML = html;
}

function formatTimer(seconds) {
  const h = String(Math.floor(seconds / 3600)).padStart(2,'0');
  const m = String(Math.floor((seconds % 3600)/60)).padStart(2,'0');
  const s = String(seconds % 60).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

function addToHistory(type, details) {
  let h = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
  h.unshift({type, details, time: Date.now(), status: "pending"});
  localStorage.setItem(HISTORY_KEY, JSON.stringify(h));
}

function updateHistory() {
  let h = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
  const now = Date.now();
  let html = "";
  h.forEach(item => {
    const elapsed = (now - item.time) / 1000;
    if (elapsed >= 43200) item.status = "success";
    const remaining = Math.max(0, 43200 - elapsed);
    const t = new Date(item.time).toLocaleString();
    html += `<div class="history-item ${item.status==='success'?'success':''}">
      <b>${item.type}</b><br>${item.details}<br><small>${t}</small><br>
      ${item.status==='success' ? '<div class="success-text">Success</div>' : `<div class="timer">${formatTimer(remaining)}</div>`}
    </div>`;
  });
  document.getElementById("historyList").innerHTML = html || "<p style='text-align:center;color:#666'>No history yet</p>";
}

function submitRedeem() {
  const name = document.getElementById("redeemName").value.trim();
  const email = document.getElementById("redeemEmail").value.trim();
  if (!name || !email.includes("@gmail.com")) return Telegram.WebApp.showAlert("Valid Name & Gmail daal!");
  const cost = selectedINR === 10 ? 3200 : selectedINR === 20 ? 6400 : selectedINR === 50 ? 16000 : 32000;
  if (points < cost) return Telegram.WebApp.showAlert("Points kam hain!");
  points -= cost; localStorage.setItem(POINT_KEY, points);
  fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:CHANNEL_ID, text:`NEW â‚¹${selectedINR} GOOGLE PLAY\nUser: ${userName} (${userId})\nName: ${name}\nEmail: ${email}`, parse_mode:"HTML"})
  });
  addToHistory(`Google Play â‚¹${selectedINR}`, `${name} | ${email}`);
  closeModal(); 
  Telegram.WebApp.showAlert(`â‚¹${selectedINR} request successful!\n12 hours mein code milega`);
  update();
}

function withdrawLTC() {
  if (points < 3200) return Telegram.WebApp.showAlert("3200 points chahiye!");
  const addr = document.getElementById("ltcAddr").value.trim();
  if (addr.length < 26) return Telegram.WebApp.showAlert("Valid LTC address daal!");
  points -= 3200; localStorage.setItem(POINT_KEY, points);
  fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:CHANNEL_ID, text:`NEW $0.1 LTC REQUEST\nUser: ${userName} (${userId})\nAddress: <code>${addr}</code>`, parse_mode:"HTML"})
  });
  addToHistory("Litecoin $0.1", addr);
  Telegram.WebApp.showAlert("LTC request successful! 12 hours mein payment");
  update();
}

function startGame() { document.getElementById("startScreen").style.display="none"; document.getElementById("gameArea").style.display="block"; update(); }
function openWallet() { closeScreen(); document.getElementById("walletScreen").style.display="block"; update(); }
function closeScreen() { document.querySelectorAll(".screen").forEach(el=>el.style.display="none"); }
function closeModal() { document.getElementById("redeemModal").style.display="none"; }
function openRedeem(inr) { selectedINR = inr; document.getElementById("redeemModal").style.display="block"; }

function showTab(tab) {
  document.getElementById("googleTab").style.display = tab==="google"?"block":"none";
  document.getElementById("ltcTab").style.display = tab==="ltc"?"block":"none";
  document.getElementById("historyTab").style.display = tab==="history"?"block":"none";
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");
}

setInterval(updateHistory, 1000);
update();
</script>

<!-- Purana CSS add kar dena <style> mein if missing -->
<style>
/* Paste your full CSS here from original code */
body{margin:0;padding:0;background:#000;font-family:'Segoe UI',sans-serif;color:#fff;overflow:hidden}
/* ... baaki sab CSS ... */
</style>

</body>
</html>
